#include "pfunc.h"

void send_file(int new_fd){
	td t;
	memset(&t,0,sizeof(t));
	t.len=strlen(FILENAME);
	printf("C:len=%d\n",t.len);//打印名字长度
	strcpy(t.buf,FILENAME);
	send_n(new_fd,(char*)&t,4+t.len);
	int fd;
	fd=open(FILENAME,O_RDONLY);
	if(-1==fd){
		perror("open");
		exit(-1);
	}

	//传出文件的总大小
	
	FILE *fp=fopen(FILENAME,"r+");
	long start,end,lenth;
	if(fp){
		start=ftell(fp);
		fseek(fp,0,SEEK_END);
		end=ftell(fp);
		lenth=end-start;
		fseek(fp,0,SEEK_SET);
		fclose(fp);
	}
	send_n(new_fd,(char*)&lenth,8);//long是8个字节

	//传出文件的内容
	while(memset(&t,0,sizeof(t)),(t.len=read(fd,t.buf,sizeof(t.buf)))>0){
		send_n(new_fd,(char*)&t,4+t.len);
	}
	t.len=0;
	send_n(new_fd,(char*)&t.len,4);
	close(new_fd);
}
